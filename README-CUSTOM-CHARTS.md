# 自定义图表模块集成说明

## 📋 项目进度

### 当前分支：1.6

### 最近更新（2025-10-17）

#### ✅ 已完成功能

1. **数据汇总功能** (commit: 2b01dbd)
   - 在日期筛选器右侧添加"数据汇总"复选框
   - 勾选后显示所选日期范围内的指标汇总值
   - 支持多种聚合类型：sum、avg、max、min、count
   - 实时切换汇总模式和详细模式

2. **日期维度统一** (commit: df7aec3)
   - 确保所有7个演示数据集都包含统一的日期维度
   - 日期维度作为必选项，不可删除
   - 生成90天的模拟数据用于测试

3. **字段搜索功能** (commit: 95cd9c3)
   - 数据集搜索框：快速过滤数据集列表
   - 维度搜索框：实时搜索维度字段
   - 指标搜索框：实时搜索指标字段
   - 修复搜索框宽度溢出问题

4. **维度筛选器优化**
   - 日期筛选器：支持日/周/月/季/年粒度选择
   - 分类筛选器：支持多选、搜索、全选/清空操作
   - 筛选器 UI 与图表类型选择器同行显示

5. **图表类型支持** (24种)
   - 基础图表：柱状图、折线图、饼图、面积图
   - 表格类型：普通表格、数据透视表、趋势分析表、OKR表格、原始数据表
   - 高级图表：堆叠柱状图、堆叠条形图、双轴图、双向条形图
   - 专业图表：填充地图、词云图、直方图、指标卡、漏斗图、雷达图、桑基图、瀑布图

### 当前实现的技术特性

- ✅ 三栏布局编辑器（数据集选择、配置预览、图表预览）
- ✅ 拖拽式字段选择（点击添加维度和指标）
- ✅ 实时图表预览（配置变更自动更新）
- ✅ 多数据集支持（7个预置演示数据集）
- ✅ localStorage 持久化存储
- ✅ 图表配置验证（数据要求提示）
- ✅ 响应式布局设计
- ✅ 局域网访问支持

### 数据集列表

1. **广告基础数据** (ads_basic) - 广告投放效果数据
2. **销售业绩数据** (sales_performance) - 多维度销售业绩分析
3. **网站流量数据** (web_traffic) - 网站访问流量统计
4. **客户满意度数据** (customer_satisfaction) - 客户满意度调查
5. **地理销售数据** (geo_sales) - 各省市销售分布
6. **产品目录数据** (product_catalog) - 产品销售与评价
7. **营销漏斗数据** (marketing_funnel) - 营销转化漏斗

### 待优化项

- [ ] 支持图表多指标非汇总模式（当前 runLocalQuery 仅支持单维度+单指标）
- [ ] 添加更多预置主题和样式配置
- [ ] 实现图表联动和钻取功能
- [ ] 添加数据导出功能（Excel、CSV、图片）
- [ ] 优化构建产物大小（当前约 7.7MB）

## 🎯 功能概述

本项目已成功集成自定义图表管理模块，包含以下核心功能：

### 📊 主要特性
- **管理页面**：图表列表展示、搜索筛选、标签管理、删除操作
- **创建/编辑页面**：三栏布局的图表编辑器，支持多种图表类型
- **内嵌显示**：在主页面内容区域无缝集成，保持导航栏和侧边栏常在
- **默认加载**：页面初始化时自动加载管理页面
- **本地存储**：所有数据存储在浏览器 localStorage 中
- **局域网访问**：支持通过本机 IP + 端口在局域网内访问

### 🔧 技术架构
- **前端框架**：React 18 + TypeScript + Vite
- **图表库**：ECharts 5.x
- **样式**：CSS Modules + 响应式设计
- **数据存储**：localStorage（无需后端服务）
- **通信机制**：PostMessage API（iframe 与父页面通信）

## 🚀 快速启动

### 方式一：生产环境（推荐）

1. **构建项目**
```bash
npm --prefix custom-charts run build
```

2. **启动静态服务器**
```bash
# 使用 Python（推荐）
python3 -m http.server 8080 --bind 0.0.0.0

# 或使用 Node.js serve
npm install -g serve
serve -l 8080 .
```

3. **访问应用**
- 本机访问：http://127.0.0.1:8080/index.html
- 局域网访问：http://你的IP地址:8080/index.html

### 方式二：开发环境

1. **启动开发服务器**
```bash
npm --prefix custom-charts run dev -- --host
```

2. **访问应用**
- 开发服务器：http://localhost:5173
- 主页面：打开 index.html（静态文件）

## 📱 使用指南

### 基本操作流程

1. **访问主页面**
   - 打开 index.html
   - 系统会自动在内容区域加载自定义图表管理页面

2. **管理图表**
   - 查看所有已创建的图表（卡片视图）
   - 使用搜索框按名称搜索图表
   - 按图表类型、发布状态筛选
   - 按创建/修改时间排序
   - 添加/编辑图表标签
   - 删除不需要的图表

3. **创建新图表**
   - 点击"创建图表"按钮
   - 在左侧选择数据集和字段
   - 在右侧配置维度和指标
   - 在中间预览图表效果
   - 选择图表类型（柱状图、折线图、饼图、表格）
   - 输入图表名称并保存

4. **编辑现有图表**
   - 在管理页面点击图表的"修改"按钮
   - 修改配置后保存更新

### 支持的图表类型

- **柱状图**：适合比较不同类别的数值
- **折线图**：适合展示趋势变化
- **饼图**：适合展示占比关系
- **表格**：适合展示详细数据

### 预置数据说明

系统预置了广告数据演示集：
- **维度字段**：日期、广告主名称
- **指标字段**：展示数、点击数、消耗金额
- **样本数据**：包含最近几天的模拟广告数据

## 🔍 故障排除

### 常见问题

1. **页面无法加载**
   - 检查静态服务器是否正常运行
   - 确认端口 8080 未被占用
   - 检查浏览器控制台是否有错误信息

2. **图表不显示**
   - 确保选择了至少一个维度和一个指标
   - 检查数据是否正确加载到 localStorage
   - 尝试刷新页面重新初始化

3. **内嵌显示异常**
   - 检查浏览器是否支持 iframe
   - 确认没有被广告拦截器阻止
   - 查看浏览器控制台的错误信息

### 调试工具

在浏览器控制台中可以使用以下调试命令：

```javascript
// 运行完整验证测试
verifyCustomCharts.runAll()

// 手动打开自定义图表
window.openCustomCharts('manage')  // 管理页面
window.openCustomCharts('editor')  // 编辑页面

// 调试信息
window.debugCustomCharts()

// 检查本地存储
console.log('数据集:', JSON.parse(localStorage.getItem('bi_datasets')))
console.log('图表:', JSON.parse(localStorage.getItem('bi_user_queries')))
```

## 📁 文件结构

```
dataease_custom_chart/
├── index.html                    # 主页面（已集成自定义图表）
├── custom-charts/                # Vite + React 项目
│   ├── dist/                     # 构建输出目录
│   │   ├── manage.html           # 管理页面
│   │   ├── editor.html           # 编辑页面
│   │   └── assets/               # 静态资源
│   ├── src/
│   │   ├── pages/
│   │   │   ├── manage/           # 管理页面源码
│   │   │   └── editor/           # 编辑页面源码
│   │   ├── shared/
│   │   │   └── storage.ts        # 数据存储逻辑
│   │   └── styles/               # 样式文件
│   ├── manage.html               # 管理页面入口
│   ├── editor.html               # 编辑页面入口
│   └── vite.config.ts            # Vite 配置
├── custom-charts-static/         # 静态版本（备用）
├── test-integration.html         # 集成测试页面
├── verify-setup.js               # 验证脚本
└── README-CUSTOM-CHARTS.md       # 本说明文档
```

## 🔧 技术细节

### 内嵌机制

1. **自动检测内容区域**：智能识别主页面的内容显示区域
2. **动态创建 iframe**：在内容区域创建 iframe 容器
3. **响应式布局**：自动适配不同屏幕尺寸
4. **消息通信**：通过 PostMessage API 实现页面间通信

### 数据存储结构

```javascript
// localStorage 键值
{
  "bi_datasets": [...],      // 数据集定义
  "bi_user_queries": [...],  // 用户创建的图表
  "bi_ui_preferences": {...} // UI 偏好设置
}
```

### 构建配置

- **多页面入口**：manage.html 和 editor.html
- **局域网支持**：server.host: true
- **TypeScript 支持**：完整的类型定义
- **模块解析**：支持 @ 别名路径

## 📈 后续扩展

可以考虑添加的功能：
- 更多图表类型（散点图、热力图、雷达图等）
- 拖拽排序功能
- 图表导出功能
- 数据源连接
- 权限管理
- 图表分享

## 🆘 技术支持

如遇到问题，请：
1. 查看浏览器控制台错误信息
2. 运行 `verifyCustomCharts.runAll()` 进行诊断
3. 检查网络连接和端口占用情况
4. 确认浏览器版本支持现代 JavaScript 特性
